<html>
<head>
<script>
//http://youmightnotneedjquery.com/#ready
function ready(fn) {
  if (document.readyState != 'loading'){
    fn();
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', fn);
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState != 'loading')
        fn();
    });
  }
}

const ipc      = require("electron").ipcRenderer;
const os       = require('os');
const route    = require('default-network');

var userhome   = process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
const nconf    = require('nconf').file({file: userhome + '/electron_setup.json'});


var interfaces, defaultInterface;

var saveBtn, interfacesSelect;


ready(function() {

    var eth     = document.querySelector('input[name="eth"]');
    var filter  = document.querySelector('input[name="filter"]');
    var gateway = document.querySelector('input[name="gateway"]');

    nconf.load();
    var settings   = nconf.get('settings') || {};

    eth.value     = 'eth'     in settings ? settings.eth     : '';
    filter.value  = 'filter'  in settings ? settings.filter  : 'ip';
    gateway.value = 'gateway' in settings ? settings.gateway : '';

    saveBtn = document.querySelector('#save');
    saveBtn.addEventListener('click', function () {
        console.log("saving settings");
        settings.eth = eth.value;
        settings.filter = filter.value;
        settings.gateway = gateway.value;
        nconf.set('settings', settings);
        try {
            nconf.save();
        } catch (e) {
            // this can happen when proc run first with normal user

        }
        ipc.send('settings-change', settings);
        document.body.innerHTML = "<h1>loading</h1>";
    });

    interfacesSelect = document.querySelector('#interface');

    route.collect(function(err, routes) {
        interfaces       = [];
        osEths           = os.networkInterfaces();
        defaultInterface = Object.keys(routes)[0];

        for (k in osEths) {
            // TODO: assuming IPv4 always first
            interfaces.push({
                name:    k,
                ip:      osEths[k][0]['address'],
                default: k === defaultInterface ? true : false,
                gateway: k in routes            ? routes[k][0]['address'] : null
            });
            var e = document.createElement('option');
            e.value = k;
            e.innerHTML = k+' ('+osEths[k][0]['address']+')';
            if (k === defaultInterface)
                e.checked = true;
            interfacesSelect.appendChild(e);
        }
    });

    interfacesSelect.addEventListener('change', function (e) {
        console.log("change");
        var selectedEth = interfacesSelect.options[interfacesSelect.selectedIndex].value;
        for (i in interfaces) {
            if (interfaces[i].name === selectedEth) {
                document.querySelector('input[name="eth"]').value = interfaces[i].name;
                document.querySelector('input[name="gateway"]').value = interfaces[i].gateway;
            }
        }
    });

    if (process.platform == 'linux') {
        document.querySelector('#command').innerHTML = "sudo ./snifferjs-linux-x64/snifferjs";
    }
    else if (process.platform == 'darwin') {
        document.querySelector('#command').innerHTML = "sudo sudo ./snifferjs-darwin-x64/snifferjs.app/Contents/MacOS/Electron";
    }
});
</script>
<style>
* { font-size: 16pt; font-family: sans-serif;}
body { margin: 4% 10% 10% 10% ; background-color: #dee3de;}
.help, .help a {font-size: 12pt; color: #999;}
#command { font-size: 12pt; margin: 10px; font-family: monospace;}
</style>
</head>
<body>
<div class=help>
    You might need to run Sniffer.js as root<br>
    <div id=command></div>
    For details and instructions on running run as normal see <a href="https://github.com/cyphunk/snifferjs/releases/tag/snifferjsApp_0.0.1">release notes</a>
</div><br />
<select id="interface">
<option value="" disabled="disable" >Select network interface</option>
</select><br /><br />
<table>
    <tr><td colspan=2>Or set manually<br /><br /></td></tr>
    <tr><td>Interface</td><td> <input name="eth" value="" /></td></tr>
    <tr><td colspan=2 class=help>Interface name to monitor<br />(e.g. eth0, en0, wlan0)</td></tr>
    <tr><td>Filter</td><td> <input name="filter" value="" /></td></tr>
    <tr><td colspan=2 class=help>libpcap filter<br />(e.g.  "ip and not host 192.168.1.1")</td></tr>
    <tr><td>Gateway</td><td> <input name="gateway" value="" /></td></tr>
    <tr><td colspan=2 class=help>Default router of interface. Optional.</td></tr>
</table><br />
<button id="save">Go!</button>
</body>
</html>
